{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block content %}

<div class="row justify-content-center mt-5">
    <!-- Left Sidebar / Helper Menu -->
      <div class="col-md-3 col-lg-2 mb-3">
        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-header bg-light text-center fw-semibold">
            <i class="bi bi-info-circle me-1"></i> Quick Help
          </div>
          <div class="list-group list-group-flush">

            <a href="{% url 'documentation' %}" target="_blank"
               class="list-group-item list-group-item-action d-flex align-items-center">
              <i class="bi bi-book me-2 text-primary"></i>
              <div>
                <strong>Documentation</strong><br>
                <small class="text-muted">Read detailed module guide</small>
              </div>
            </a>

            <a href="mailto:jan.binkowski@pum.edu.pl"
               class="list-group-item list-group-item-action d-flex align-items-center">
              <i class="bi bi-envelope me-2 text-success"></i>
              <div>
                <strong>Support</strong><br>
                <small class="text-muted">jan.binkowski@pum.edu.pl</small>
              </div>
            </a>

          </div>
        </div>
      </div>

    <!-- Submission form -->
    <div class="col-md-6">
        <div class="card shadow-sm rounded-4">

            <!-- Header -->
            <div class="card-header text-center">
                <h4>Submission form - {{ form_name }}</h4>
            </div>

            <!-- Body -->
            <div class="card-body">
                {{ form.media.css }}
                <form method="POST" enctype="multipart/form-data" id="wizardForm">
                    {% csrf_token %}
                    {{ wizard.management_form }}
                    {{ form|crispy }}

                    <div class="row mt-3">
                        {% if wizard.steps.prev %}
                            <!-- Previous button -->
                            <div class="col-6">
                                <button name="wizard_goto_step"
                                        type="submit"
                                        value="{{ wizard.steps.prev }}"
                                        class="btn btn-outline-primary w-100">
                                    < Previous
                                </button>
                            </div>
                        {% endif %}

                        {% if wizard.steps.next %}
                            <!-- Continue button -->
                            <div class="{% if not wizard.steps.prev %}col-12{% else%}col-6{% endif %}">
                                <button type="submit"
                                        class="btn btn-outline-primary w-100">
                                    Continue >
                                </button>
                            </div>
                        {% else %}
                            <!-- Submit (last step, with modal) -->
                            <div class="col-6 {% if not wizard.steps.prev %}offset-6{% endif %}">
                                <button type="button"
                                        class="btn btn-danger w-100"
                                        data-bs-toggle="modal"
                                        data-bs-target="#confirmSubmitModal">
                                    Submit >
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </form>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                {{ form.media.js }}
            </div>

            <!-- Footer -->
            <div class="card-footer text-center text-body-secondary">
                Step {{ wizard.steps.step1 }} of {{ wizard.steps.count }}
            </div>

        </div>
    </div>
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="confirmSubmitModal" tabindex="-1" aria-labelledby="confirmSubmitLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-3">

      <div class="modal-header bg-danger text-white">
        <h6 class="modal-title" id="confirmSubmitLabel">Confirm Submission</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body text-center">
        <p>
            After submission, modifications will not be possible.
            Please ensure confirmation in advance, as the submission will
            undergo technical checks and review. Modifications will only be
            permitted once this process has been completed.
        </p>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-outline-info" data-bs-dismiss="modal" id="cancelBtn">
          Cancel
        </button>
        <button type="button" class="btn btn-outline-danger d-flex align-items-center justify-content-center"
                id="submitBtn">
          <span id="submitText">Yes, Submit</span>
          <span id="loadingSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
        </button>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Textarea counter
    document.querySelectorAll("textarea[data-counter]").forEach(function (field) {
        const maxLength = field.getAttribute("maxlength") || 0;
        const counter = document.createElement("small");

        counter.classList.add("text-muted", "d-block", "mt-1");
        counter.textContent = `${field.value.length}/${maxLength}`;
        field.parentNode.appendChild(counter);

        field.addEventListener("input", function () {
            counter.textContent = `${field.value.length}/${maxLength}`;
        });
    });

    // Modal submit handling
    const form = document.getElementById("wizardForm");
    const submitBtn = document.getElementById("submitBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const submitText = document.getElementById("submitText");
    const spinner = document.getElementById("loadingSpinner");

    submitBtn.addEventListener("click", function () {
        // Disable both buttons
        submitBtn.disabled = true;
        cancelBtn.disabled = true;

        // Update button text + show spinner
        submitText.textContent = "Submitting...";
        spinner.classList.remove("d-none");

        // Submit the form
        form.submit();
    });
});
</script>

{% endblock %}